# Fleet Script Inventory

This catalog lists the bash, PowerShell, and Node helpers that support day-to-day operations. It captures what each script does today and whether it looks actively maintained or ready for follow-up cleanup.

## Top-level `scripts/`

| Path                                     | Description                                                                                                                                                                                                                                                    | Status / Notes                                                                                                                                                                               |
| ---------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `scripts/acceptance.sh`                  | Runs acceptance diagnostics against one or more audio hosts, including control API checks, ALSA verification, optional playback tests, and Icecast probing, while producing a structured summary of pass/warn/fail results.【F:scripts/acceptance.sh†L7-L190】 | Actively used by the automated audio acceptance flow and the VPS deployment pipeline, so keep maintained.【F:tests/acceptance/audio.test.sh†L128-L188】【F:scripts/vps-deploy.sh†L115-L196】 |
| `scripts/apply-host-config.sh`           | Rsyncs the `host-config` baseline (common + role-specific) into `/` and reloads systemd, intended to be run with a repo path and role name on a managed host.【F:scripts/apply-host-config.sh†L3-L22】                                                         | Manual provisioning helper; confirm whether we still rely on this workflow before changing or removing it.【F:scripts/apply-host-config.sh†L3-L22】                                          |
| `scripts/audioctl.sh`                    | CLI wrapper around the audio control API supporting status/config queries, playback controls, uploads, and auth handling with robust option parsing.【F:scripts/audioctl.sh†L6-L158】                                                                          | Still relevant whenever we need to interact with audio players from the shell; leave in place.【F:scripts/audioctl.sh†L6-L158】                                                              |
| `scripts/decommission.sh`                | Stops and removes all containers/volumes, logs out of Tailscale, then powers off the host after a short delay.【F:scripts/decommission.sh†L4-L16】                                                                                                             | Destructive but occasionally necessary; document before use and keep available for controlled teardown.【F:scripts/decommission.sh†L4-L16】                                                  |
| `scripts/setup-watchdogs.sh`             | Installs the watchdog daemon, loads the Raspberry Pi watchdog kernel module, deploys `fleet-watchdog-health.sh`, and ensures `/etc/watchdog.conf` points at it.【F:scripts/setup-watchdogs.sh†L1-L55】                                                         | Hardware enablement script is still applicable on Pi-based nodes; keep but review when hardware platform changes.【F:scripts/setup-watchdogs.sh†L1-L55】                                     |
| `scripts/stabilization-verification.ps1` | PowerShell smoke test that hits a hard-coded production URL, exercises key routes, and verifies security headers before printing a readiness message.【F:scripts/stabilization-verification.ps1†L1-L28】                                                       | Targets an old domain by default; confirm whether this legacy check is still meaningful or should be retired.【F:scripts/stabilization-verification.ps1†L1-L28】                             |
| `scripts/validate-device-registry.mjs`   | Node script that cross-checks `inventory/device-interfaces.yaml` with the inventory file and Prometheus target lists, flagging missing IDs, duplicate operations, and mismatched scrape targets.【F:scripts/validate-device-registry.mjs†L1-L114】             | Actively relied upon for configuration consistency; keep and integrate into validation flows.【F:scripts/validate-device-registry.mjs†L29-L114】                                             |
| `scripts/vps-deploy.sh`                  | Orchestrates VPS deployments: writes attempt metadata, runs `docker compose` with health waits, triggers acceptance checks, and manages rollback metadata/history.【F:scripts/vps-deploy.sh†L4-L200】                                                          | Production-critical automation; ensure it remains tested alongside any infrastructure changes.【F:scripts/vps-deploy.sh†L4-L200】                                                            |
| `scripts/vps-rollback.sh`                | Replays the previous successful deployment by sourcing saved environment data, reprovisioning the compose stack, and rerunning acceptance checks.【F:scripts/vps-rollback.sh†L4-L134】                                                                         | Companion to `vps-deploy`; keep maintained for recovery scenarios.【F:scripts/vps-rollback.sh†L4-L134】                                                                                      |

## `agent/` automation scripts

| Path                              | Description                                                                                                                                                                                                                                    | Status / Notes                                                                                                                                                                                       |
| --------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `agent/check-secrets.sh`          | Validates that each role’s `.env.sops.enc` exists, SOPS is installed, and the AGE key has safe permissions/ownership.【F:agent/check-secrets.sh†L3-L55】                                                                                       | Still relevant for GitOps hygiene on the nodes; keep and consider wiring into CI for secret audits.【F:agent/check-secrets.sh†L13-L55】                                                              |
| `agent/setup-claude-tools.sh`     | Ensures modern Node.js, installs/refreshes Claude Code MCP packages, caches Playwright assets, and writes managed MCP configuration and env-loader files.【F:agent/setup-claude-tools.sh†L10-L217】                                            | Useful for maintaining the Claude Code environment; review periodically as package requirements evolve.【F:agent/setup-claude-tools.sh†L18-L217】                                                    |
| `agent/logging.sh`                | Provides reusable helpers that emit structured JSON log lines with timestamps, context fields, and numeric coercion utilities for shell scripts.【F:agent/logging.sh†L4-L158】                                                                 | Library is available but not currently sourced by `role-agent`, which implements its own logger—worth evaluating for consolidation.【F:agent/logging.sh†L4-L158】【F:agent/role-agent.sh†L129-L159】 |
| `agent/role-agent.sh`             | Primary GitOps converger: resolves host role from inventory, syncs the repo, handles secrets, validates compose plans, runs `docker compose up`, manages rollback, writes metrics, and records health status.【F:agent/role-agent.sh†L4-L556】 | Mission-critical; actively used for every device converge. Keep heavily tested and documented.【F:agent/role-agent.sh†L4-L556】                                                                      |
| `agent/role-agent-watchdog.sh`    | Watchdog that runs within a maintenance window, checks for recent converges, and can restart the service or reboot once before giving up, while exporting Prometheus textfile metrics.【F:agent/role-agent-watchdog.sh†L1-L170】               | Important safeguard for stuck converges; keep and tune thresholds as operations require.【F:agent/role-agent-watchdog.sh†L1-L170】                                                                   |
| `agent/role-agent-healthcheck.sh` | Systemd healthcheck that inspects the active compose project for the host’s role, counts unhealthy containers, and recreates the stack after repeated failures.【F:agent/role-agent-healthcheck.sh†L4-L114】                                   | Active remediation hook; should remain installed wherever `role-agent` runs.【F:agent/role-agent-healthcheck.sh†L4-L114】                                                                            |
| `agent/fleet-watchdog-health.sh`  | Lightweight health probe executed by the hardware watchdog that validates Docker availability, determines the host role, and ensures associated containers are healthy before signalling success.【F:agent/fleet-watchdog-health.sh†L1-L48】   | Supports the watchdog configuration installed by `setup-watchdogs`; keep in sync with compose naming conventions.【F:agent/fleet-watchdog-health.sh†L1-L48】                                         |
| `agent/watchdog-health.sh`        | CLI check that validates the freshness and status fields of `/var/run/fleet/health.json`, failing when stale, degraded, or errored.【F:agent/watchdog-health.sh†L4-L44】                                                                       | Serves as a simple monitoring probe—still relevant for watchdog/service health dashboards.【F:agent/watchdog-health.sh†L4-L44】                                                                      |
| `agent/plan.sh`                   | Prints the compose files that would apply for a host/role by parsing the inventory and listing role overlays, including a suggested compose command.【F:agent/plan.sh†L1-L60】                                                                 | Handy for dry-run planning and documentation; keep available for operators.【F:agent/plan.sh†L31-L60】                                                                                               |
| `agent/validate-inventory.sh`     | Parses `inventory/devices.yaml` and verifies every host has a role (or a specific host when filtered), guiding authors on how to fix gaps.【F:agent/validate-inventory.sh†L1-L58】                                                             | Active validation helper used by acceptance tests; keep and possibly hook into CI.【F:agent/validate-inventory.sh†L24-L58】                                                                          |
| `agent/tests/acceptance.sh`       | Spins up a throwaway run dir and exercises `validate-inventory`, `plan`, and `role-agent` (dry-run/full-run), including negative tests via a broken overlay to verify error handling.【F:agent/tests/acceptance.sh†L1-L144】                   | Important regression suite for the agent; retain and keep running in automated pipelines.【F:agent/tests/acceptance.sh†L79-L140】                                                                    |

## Role, testing, and ancillary scripts

| Path                                    | Description                                                                                                                                                                                                     | Status / Notes                                                                                                                                                       |
| --------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `tests/acceptance/audio.test.sh`        | Wraps `scripts/acceptance.sh` to produce JSON + JUnit reports, derive host lists from Prometheus target files, and verify metrics endpoints for each scrape target.【F:tests/acceptance/audio.test.sh†L1-L200】 | Active part of the acceptance test suite; maintain alongside audio role updates.【F:tests/acceptance/audio.test.sh†L1-L200】                                         |
| `backups/backup.sh`                     | Minimal Restic backup helper that initializes the repo if needed, backs up `/backup`, and prunes using daily/weekly/monthly retention policies.【F:backups/backup.sh†L1-L7】                                    | Still useful where Restic is deployed; review retention values but keep script available.【F:backups/backup.sh†L1-L7】                                               |
| `roles/audio-player/tests/run_tests.sh` | Role-specific validation that logs results, hits audio-control endpoints, checks ALSA devices, and confirms Docker containers are running.【F:roles/audio-player/tests/run_tests.sh†L1-L182】                   | Valuable smoke test for audio players; keep with the role and refresh checks as services evolve.【F:roles/audio-player/tests/run_tests.sh†L117-L182】                |
| `roles/hdmi-media/install.sh`           | Installs OS packages and drops the default configuration needed for the HDMI media role, with follow-up instructions for systemd units.【F:roles/hdmi-media/install.sh†L4-L14】                                 | Provisioning helper; confirm instructions remain accurate for current images.【F:roles/hdmi-media/install.sh†L4-L14】                                                |
| `roles/hdmi-media/tests/run_tests.sh`   | Similar harness that loads env secrets, probes media-control/Zigbee endpoints, exercises MQTT, and validates containers for the HDMI media stack.【F:roles/hdmi-media/tests/run_tests.sh†L1-L192】              | Keep as an operational checklist for HDMI devices; update when dependencies change.【F:roles/hdmi-media/tests/run_tests.sh†L124-L192】                               |
| `roles/camera/tests/run_tests.sh`       | Camera role validation that checks MediaMTX endpoints, RTSP connectivity, container health, and optionally inspects the stream with `ffprobe`.【F:roles/camera/tests/run_tests.sh†L117-L159】                   | Active diagnostic; retain and adjust as the camera stack evolves.【F:roles/camera/tests/run_tests.sh†L117-L159】                                                     |
| `roles/camera/streamer/entrypoint.sh`   | Container entrypoint that waits for the RTSP server before piping `libcamera-vid` output into `ffmpeg` for streaming.【F:roles/camera/streamer/entrypoint.sh†L4-L29】                                           | Core to the camera streamer container—keep maintained alongside image updates.【F:roles/camera/streamer/entrypoint.sh†L4-L29】                                       |
| `apps/ui/scripts/generate-openapi.mjs`  | Generates (or stubs) TypeScript clients for the UI from the API OpenAPI spec, falling back to placeholders when the spec is missing.【F:apps/ui/scripts/generate-openapi.mjs†L1-L52】                           | Useful during UI development; retain and ensure documentation references `npm run openapi:generate` appropriately.【F:apps/ui/scripts/generate-openapi.mjs†L24-L52】 |
