# Audio API Runbook

This runbook covers day-two operations for the audio control endpoints that back daily playback actions. The API is a thin fa√ßade over Prisma-backed state and stubbed device coordination, so most failures are data-related or due to lost device registry information.

## Common failure scenarios

### 401/403 responses in UI

- **Symptom:** UI shows audio panels with authentication errors.
- **Checks:** Confirm the Fleet UI bearer token via `kubectl get secret fleet-api`. Ensure `API_BEARER` matches in the API deployment.
- **Remediation:** Redeploy API with updated token or rotate credentials. No DB changes are needed.

### 404 when starting playback

- **Symptom:** `/audio/playback` returns `not_found` when selecting a playlist.
- **Checks:** Inspect `AudioPlaylist` table for the requested ID (`sqlite3 fleet.db 'select id,name from AudioPlaylist'`). Also confirm the playlist contains tracks via `AudioPlaylistTrack`.
- **Remediation:** Recreate the playlist through the UI or seed script. If the playlist exists, verify referenced `AudioTrack` rows.

### Drift metrics stuck above zero

- **Symptom:** Operators see persistent non-zero drift in `/audio/overview`.
- **Checks:** Fetch device snapshots to confirm `playback.driftSeconds`. Review recent timeline events for `nudge`/`resync` entries (should be generated by device agents once implemented).
- **Remediation:** Issue `/audio/devices/{id}/seek` to snap devices back to a known position. If drift persists, mark the device degraded via the future device worker once implemented.

### Upload failures (413 or 500)

- **Symptom:** Uploading large tracks fails.
- **Checks:** Review API logs for `multer` size limit violations. Ensure storage path `apps/api/prisma/data/audio-library` is writable inside the pod.
- **Remediation:** Increase `MULTER_MAX_FILE_SIZE` env (future work) or reduce file size. For 500 errors, clean up partial files from the storage directory.

## Troubleshooting steps

1. **Check API health**: `kubectl exec -it <pod> -- curl -H "Authorization: Bearer $TOKEN" http://localhost:3000/audio/overview`.
2. **Inspect database state**: Use the Prisma studio or direct SQLite queries to inspect `AudioTrack`, `AudioPlaylist`, and `AudioSession` tables.
3. **Regenerate fixtures**: Run `npm run tsx src/scripts/seed-audio.ts` inside the API container to restore demo content.
4. **Reset a device**: If a device is stuck, call `/audio/devices/{deviceId}/stop` followed by `/audio/devices/{deviceId}/resume` after a fresh `/audio/playback` request.

## Escalation

- If DB corruption is suspected, capture the `fleet.db` artifact and page the Platform DB on-call.
- For contract mismatches or schema issues, file a ticket with the C1 contract owners before rolling back changes.
- Document any manual drift corrections in Ops notes for end-of-day review.
