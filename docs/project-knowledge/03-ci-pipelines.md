# CI Pipelines

This document tracks active GitHub Actions workflows, their stages, and the mitigations in place for historical breakages. Treat it as the control surface for pipeline maintenance.

## Workflow inventory

| Workflow          | Trigger                                | Key stages                                                                                                                                                                                                                                          | Notes                                                                                                                                                                                   |
| ----------------- | -------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `ci.yml`          | Pull requests                          | Matrixed lint/typecheck/build/test on Node 20.x & 22.x. Runs ESLint, Prettier check, ShellCheck, TypeScript `--noEmit`, `npm run build` for API/UI, Vitest, Playwright install, acceptance smoke scripts, and artifact collection.                  | Uses mocked devices via `VITE_USE_MOCKS=1`, `DATABASE_URL=file:./data/fleet-ci.db`, and caches Playwright browsers for speed.【F:.github/workflows/ci.yml†L1-L132】                     |
| `contract-ci.yml` | Push/PR touching API/UI/contract files | Installs root + mock deps, lints OpenAPI with Spectral, regenerates client bindings, runs diff guard, and probes the mock server endpoints (401/504 scenarios) to ensure contract regressions are caught.                                           | Fails if `npm run openapi:generate` introduces uncommitted changes or mock server health probes break.【F:.github/workflows/contract-ci.yml†L1-L55】                                    |
| `deploy-vps.yml`  | Push to `main`                         | Builds API/UI Docker images, pushes to GHCR, syncs repo to VPS, executes `scripts/vps-deploy.sh`, waits for `/api/healthz` & `/` checks, then runs `scripts/acceptance.sh` against production devices. Posts commit comment summarizing deployment. | Requires secrets `GHCR_PAT`, `VPS_*`, `ACCEPTANCE_*`. Rollback workflow uses the state recorded by `scripts/vps-deploy.sh`.【F:README.md†L106-L151】【F:scripts/vps-deploy.sh†L1-L200】 |
| `acceptance.yml`  | Manual dispatch                        | Runs `scripts/acceptance.sh` with provided hosts/stream to validate Icecast + audio playback on demand.                                                                                                                                             | Mirrors the same script used post-deploy; use for incident response smoke tests.                                                                                                        |
| `docs.yml`        | Push to `main`                         | Markdown lint/structure validation, ensures runbooks present, publishes docs artifact.                                                                                                                                                              | Keeps documentation consistent with repo expectations.                                                                                                                                  |
| `rollback.yml`    | Manual dispatch                        | Restores previous deployment on VPS via `scripts/vps-rollback.sh`.                                                                                                                                                                                  | Relies on `.deploy/previous-successful.env` created by deploy workflow.                                                                                                                 |

## Known failure modes & fixes

- **Prisma binary downloads in CI** – `ci.yml` pins `PRISMA_CLIENT_ENGINE_TYPE=binary` and sets `PRISMA_ENGINES_CHECKSUM_IGNORE_MISSING=1` during tests to avoid platform mismatch errors observed on hosted runners.【F:.github/workflows/ci.yml†L15-L118】
- **Playwright install flakiness** – Browsers are cached per Node version; ensure `apps/ui/package-lock.json` changes bump the cache key. If install fails mid-run, re-run the job after clearing the GitHub Actions cache entry.
- **OpenAPI drift** – `contract-ci.yml` fails if generated types differ. After modifying `apps/api/openapi.yaml`, run `npm run openapi:generate` from repo root (wrapping UI client generation) and commit the resulting `apps/ui/src/lib/api/generated` artifacts.
- **Acceptance smoke timeouts** – Deploy workflow uses `scripts/acceptance.sh` with `--play-both` default hosts. When device availability changes, update `ACCEPTANCE_HOSTS` secret and corresponding `inventory/devices.yaml` so smoke tests probe active hardware only.【F:inventory/devices.yaml†L1-L13】

## Operator checklist

- Watch for failing annotations on PRs; `ci.yml` reports ESLint/Prettier errors inline and uploads Vitest/Playwright artifacts to `artifacts/` for download.
- For API contract changes, validate the mock server locally using `npm run mock` and the curl probes defined in `contract-ci.yml`.
- After production deploys, confirm `/api/healthz`, `/health/events/recent`, and UI `/logs` render before acknowledging the deployment summary comment. In case of failure, trigger `rollback.yml` which replays the `.deploy/previous-successful.env` manifest.

See [16-ci-fixes-history](./16-ci-fixes-history.md) for a chronological log of remediation steps.
