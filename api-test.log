
> fleet-backend-api@1.0.0 test
> vitest run


 RUN  v3.2.4 /opt/fleet/apps/api

 ✓ tests/unit/errors.test.ts (3 tests) 18ms
 ✓ tests/unit/correlation.test.ts (2 tests) 14ms
 ✓ tests/unit/schema.test.ts (7 tests) 14ms
 ✓ tests/integration/prisma-serialization.test.ts (1 test) 659ms
   ✓ Prisma TEXT serialization > returns parsed objects from text-backed Prisma columns  657ms
{"level":30,"time":"2025-09-24T10:28:39.957Z","service":"fleet-api","msg":"request_completed","route":"/audio/:deviceId/status","method":"GET","status":200,"latency_ms":82.53,"deviceId":"pi-audio-test","correlationId":"f3eb1b38-934c-428c-b750-d60ab6c55bcf"}
{"level":50,"time":"2025-09-24T10:28:40.004Z","service":"fleet-api","msg":"request_failed","route":"/audio/pi-audio-test/status","method":"GET","status":401,"correlationId":"3a4e9882-c920-4813-a5ee-1e61553b0d5b","error":{"message":"Missing bearer token","stack":"Error: Missing bearer token\n    at createHttpError (/opt/fleet/apps/api/src/util/errors.ts:45:10)\n    at bearerAuth (/opt/fleet/apps/api/src/auth/bearer.ts:20:17)\n    at Layer.handleRequest (/opt/fleet/apps/api/node_modules/router/lib/layer.js:152:17)\n    at trimPrefix (/opt/fleet/apps/api/node_modules/router/index.js:342:13)\n    at /opt/fleet/apps/api/node_modules/router/index.js:297:9\n    at processParams (/opt/fleet/apps/api/node_modules/router/index.js:582:12)\n    at next (/opt/fleet/apps/api/node_modules/router/index.js:291:5)\n    at rateLimit (/opt/fleet/apps/api/src/middleware/rate-limit.ts:81:3)\n    at Layer.handleRequest (/opt/fleet/apps/api/node_modules/router/lib/layer.js:152:17)\n    at trimPrefix (/opt/fleet/apps/api/node_modules/router/index.js:342:13)"}}
{"level":30,"time":"2025-09-24T10:28:40.007Z","service":"fleet-api","msg":"request_completed","route":"/audio/pi-audio-test/status","method":"GET","status":401,"latency_ms":9.88,"correlationId":"3a4e9882-c920-4813-a5ee-1e61553b0d5b"}
{"level":40,"time":"2025-09-24T10:28:40.054Z","service":"fleet-api","msg":"circuit_open","deviceId":"pi-audio-test","failures":2}
{"level":50,"time":"2025-09-24T10:28:40.057Z","service":"fleet-api","msg":"request_failed","route":"/audio/:deviceId/play","method":"POST","status":409,"deviceId":"pi-audio-test","correlationId":"9ab2423b-09a8-4b3d-8178-271d5e0da5c9","error":{"message":"Device pi-audio-test reported a conflict","stack":"Error: Device pi-audio-test reported a conflict\n    at createHttpError (/opt/fleet/apps/api/src/util/errors.ts:45:10)\n    at handleHttpError (/opt/fleet/apps/api/src/upstream/http.ts:117:12)\n    at httpRequest (/opt/fleet/apps/api/src/upstream/http.ts:187:27)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at httpRequestJson (/opt/fleet/apps/api/src/upstream/http.ts:231:20)\n    at /opt/fleet/apps/api/src/routes/audio.ts:99:20"}}
{"level":30,"time":"2025-09-24T10:28:40.058Z","service":"fleet-api","msg":"request_completed","route":"/audio/:deviceId/play","method":"POST","status":409,"latency_ms":19.64,"deviceId":"pi-audio-test","correlationId":"9ab2423b-09a8-4b3d-8178-271d5e0da5c9"}
{"level":40,"time":"2025-09-24T10:28:40.093Z","service":"fleet-api","msg":"circuit_open","deviceId":"pi-audio-test","failures":2}
{"level":50,"time":"2025-09-24T10:28:40.095Z","service":"fleet-api","msg":"request_failed","route":"/audio/:deviceId/status","method":"GET","status":502,"deviceId":"pi-audio-test","correlationId":"d49003f3-043f-4f6d-8e27-642aa078fa29","error":{"message":"Device pi-audio-test is unreachable","stack":"Error: Device pi-audio-test is unreachable\n    at createHttpError (/opt/fleet/apps/api/src/util/errors.ts:45:10)\n    at mapUpstreamError (/opt/fleet/apps/api/src/util/errors.ts:93:9)\n    at httpRequest (/opt/fleet/apps/api/src/upstream/http.ts:200:29)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at httpRequestJson (/opt/fleet/apps/api/src/upstream/http.ts:231:20)\n    at /opt/fleet/apps/api/src/routes/audio.ts:31:20"}}
{"level":30,"time":"2025-09-24T10:28:40.097Z","service":"fleet-api","msg":"request_completed","route":"/audio/:deviceId/status","method":"GET","status":502,"latency_ms":28.23,"deviceId":"pi-audio-test","correlationId":"d49003f3-043f-4f6d-8e27-642aa078fa29"}
{"level":40,"time":"2025-09-24T10:28:40.532Z","service":"fleet-api","msg":"circuit_open","deviceId":"pi-audio-test","failures":2}
{"level":50,"time":"2025-09-24T10:28:40.533Z","service":"fleet-api","msg":"request_failed","route":"/audio/:deviceId/status","method":"GET","status":504,"deviceId":"pi-audio-test","correlationId":"9ba2b26d-c026-4afc-91a8-7bad677cdb77","error":{"message":"Device pi-audio-test timed out during GET /status","stack":"Error: Device pi-audio-test timed out during GET /status\n    at createHttpError (/opt/fleet/apps/api/src/util/errors.ts:45:10)\n    at mapUpstreamError (/opt/fleet/apps/api/src/util/errors.ts:84:9)\n    at httpRequest (/opt/fleet/apps/api/src/upstream/http.ts:200:29)\n    at processTicksAndRejections (node:internal/process/task_queues:95:5)\n    at httpRequestJson (/opt/fleet/apps/api/src/upstream/http.ts:231:20)\n    at /opt/fleet/apps/api/src/routes/audio.ts:31:20"}}
{"level":30,"time":"2025-09-24T10:28:40.539Z","service":"fleet-api","msg":"request_completed","route":"/audio/:deviceId/status","method":"GET","status":504,"latency_ms":428.49,"deviceId":"pi-audio-test","correlationId":"9ba2b26d-c026-4afc-91a8-7bad677cdb77"}
{"level":50,"time":"2025-09-24T10:28:40.574Z","service":"fleet-api","msg":"request_failed","route":"/audio/:deviceId/volume","method":"POST","status":422,"deviceId":"pi-audio-test","correlationId":"96ada61c-ea1c-4d98-8045-f018ca08919f","error":{"message":"[\n  {\n    \"origin\": \"number\",\n    \"code\": \"too_big\",\n    \"maximum\": 2,\n    \"inclusive\": true,\n    \"path\": [\n      \"volume\"\n    ],\n    \"message\": \"Too big: expected number to be <=2\"\n  }\n]","stack":"ZodError: [\n  {\n    \"origin\": \"number\",\n    \"code\": \"too_big\",\n    \"maximum\": 2,\n    \"inclusive\": true,\n    \"path\": [\n      \"volume\"\n    ],\n    \"message\": \"Too big: expected number to be <=2\"\n  }\n]\n    at /opt/fleet/apps/api/src/routes/audio.ts:77:39\n    at Layer.handleRequest (/opt/fleet/apps/api/node_modules/router/lib/layer.js:152:17)\n    at next (/opt/fleet/apps/api/node_modules/router/lib/route.js:157:13)\n    at Route.dispatch (/opt/fleet/apps/api/node_modules/router/lib/route.js:117:3)\n    at handle (/opt/fleet/apps/api/node_modules/router/index.js:435:11)\n    at Layer.handleRequest (/opt/fleet/apps/api/node_modules/router/lib/layer.js:152:17)\n    at /opt/fleet/apps/api/node_modules/router/index.js:295:15\n    at param (/opt/fleet/apps/api/node_modules/router/index.js:600:14)\n    at param (/opt/fleet/apps/api/node_modules/router/index.js:610:14)\n    at processParams (/opt/fleet/apps/api/node_modules/router/index.js:664:3)"}}
{"level":30,"time":"2025-09-24T10:28:40.576Z","service":"fleet-api","msg":"request_completed","route":"/audio/:deviceId/volume","method":"POST","status":422,"latency_ms":5.62,"deviceId":"pi-audio-test","correlationId":"96ada61c-ea1c-4d98-8045-f018ca08919f"}
 ✓ tests/integration/audio-proxy.test.ts (6 tests) 748ms
   ✓ Audio proxy integration > returns 504 on upstream timeout  454ms

 Test Files  5 passed (5)
      Tests  19 passed (19)
   Start at  12:28:37
   Duration  2.72s (transform 978ms, setup 123ms, collect 2.26s, tests 1.45s, environment 2ms, prepare 1.10s)

